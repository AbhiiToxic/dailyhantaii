<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
</head>
<body class="dark">
  <div class="container">
    <div class="header">
      <h1>Admin Panel</h1>
    </div>
    <form id="add-form">
      <input type="text" id="preview" placeholder="Preview link" required>
      <input type="text" id="download" placeholder="Download link" required>
      <button type="submit">Add Button</button>
    </form>
    <div id="stats-section">
      <h2>Stats</h2>
      <p id="link-count"></p>
      <p id="visit-count"></p>
      <p id="click-count"></p>
    </div>
    <table id="links-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Preview</th>
          <th>Download</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <script>
    function createRow(link) {
      const row = document.createElement('tr');
      row.dataset.id = link.name;
      row.innerHTML = `
        <td>${link.name}</td>
        <td><a href="${link.preview}" target="_blank">Preview</a></td>
        <td><a href="${link.download}" target="_blank">Download</a></td>
        <td>
          <button class="edit-btn">Edit</button>
          <button class="delete-btn">Delete</button>
        </td>`;
      row.querySelector('.edit-btn').addEventListener('click', () => editLink(link.name, row));
      row.querySelector('.delete-btn').addEventListener('click', () => deleteLink(link.name, row));
      return row;
    }

      async function loadAdmin() {
        const res = await fetch('/api/links');
        const data = await res.json();
      document.getElementById('link-count').textContent = `Total buttons: ${data.length}`;
        const tbody = document.querySelector('#links-table tbody');
        tbody.innerHTML = '';
        for (const link of data) {
          tbody.appendChild(createRow(link));
        }
    }

    async function loadStats() {
      const res = await fetch('/stats.json');
      const data = await res.json();
      const visits = data.filter(s => s.type === 'visit').length;
      const clicks = data.filter(s => s.type === 'click').length;
      document.getElementById('visit-count').textContent = `Visits: ${visits}`;
      document.getElementById('click-count').textContent = `Clicks: ${clicks}`;
    }
    let auth = '';

    async function request(url, options = {}) {
      if (!auth) {
        const user = prompt('Username');
        const pass = prompt('Password');
        auth = 'Basic ' + btoa(`${user}:${pass}`);
      }
      options.headers = Object.assign({}, options.headers, {
        'Authorization': auth,
        'Content-Type': 'application/json'
      });
      const res = await fetch(url, options);
      if (res.status === 401) {
        auth = '';
        alert('Auth failed');
        throw new Error('Auth failed');
      }
      return res;
    }

    async function editLink(id, row) {
      const currentPreview = row.cells[1].querySelector('a').href;
      const currentDownload = row.cells[2].querySelector('a').href;
      const preview = prompt('Preview link', currentPreview);
      if (preview === null) return;
      const download = prompt('Download link', currentDownload);
      if (download === null) return;
      const res = await request(`/api/links/${encodeURIComponent(id)}`, {
        method: 'PUT',
        body: JSON.stringify({ preview, download })
      });
      const data = await res.json();
      row.cells[1].innerHTML = `<a href="${data.preview}" target="_blank">Preview</a>`;
      row.cells[2].innerHTML = `<a href="${data.download}" target="_blank">Download</a>`;
    }

    async function deleteLink(id, row) {
      if (!confirm('Delete this link?')) return;
      await request(`/api/links/${encodeURIComponent(id)}`, { method: 'DELETE' });
      row.remove();
      const count = document.querySelectorAll('#links-table tbody tr').length;
      document.getElementById('link-count').textContent = `Total buttons: ${count}`;
    }

    document.getElementById('add-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const preview = document.getElementById('preview').value.trim();
      const download = document.getElementById('download').value.trim();
      if (!preview || !download) return;
      const res = await request('/api/add', {
        method: 'POST',
        body: JSON.stringify({ preview, download })
      });
      const entry = await res.json();
      const tbody = document.querySelector('#links-table tbody');
      tbody.appendChild(createRow(entry));
      document.getElementById('preview').value = '';
      document.getElementById('download').value = '';
      const count = parseInt(document.getElementById('link-count').textContent.split(':')[1]) || 0;
      document.getElementById('link-count').textContent = `Total buttons: ${count + 1}`;
    });

    loadAdmin();
    loadStats();
  </script>
</body>
</html>
